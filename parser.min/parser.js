// 小程序富文本插件 https://github.com/jin-yufeng/Parser
var dom;function t(t){for(var e=t.length,i=5381;e--;)i+=(i<<5)+t.charCodeAt(e);return i}var e={},i=require("./libs/MpHtmlParser.js"),n=wx.getFileSystemManager&&wx.getFileSystemManager();Component({options:{pureDataPattern:/^[acdgtu]|W/},data:{nodes:[]},properties:{html:{type:String,observer:function(t){this.setContent(t)}},autopause:{type:Boolean,value:!0},autoscroll:Boolean,autosetTitle:{type:Boolean,value:!0},compress:Number,domain:String,lazyLoad:Boolean,loadingImg:String,selectable:Boolean,tagStyle:Object,showWithAnimation:Boolean,useAnchor:Boolean,useCache:Boolean},relations:{"../parser-group/parser-group":{type:"ancestor"}},created:function(){this.imgList=[],this.imgList.setItem=function(t,e){var i=this;if(t&&e){if(0==e.indexOf("http")&&this.includes(e)){for(var a,o="",r=0;(a=e[r])&&("/"!=a||"/"==e[r-1]||"/"==e[r+1]);r++)o+=Math.random()>.5?a.toUpperCase():a;return o+=e.substr(r),this[t]=o}if(this[t]=e,e.includes("data:image")){var s=e.match(/data:image\/(\S+?);(\S+?),(.+)/);if(!s)return;var l=wx.env.USER_DATA_PATH+"/"+Date.now()+"."+s[1];n&&n.writeFile({filePath:l,data:s[3],encoding:s[2],success:function(){return i[t]=l}})}}},this.imgList.each=function(t){for(var e=0,i=this.length;e<i;e++)this.setItem(e,t(this[e],e,this))},dom&&(this.document=new dom(this))},detached:function(){this.imgList.each(function(t){t&&t.includes(wx.env.USER_DATA_PATH)&&n&&n.unlink({filePath:t})}),clearInterval(this._timer)},methods:{navigateTo:function(t){var e=this;if(!this.data.useAnchor)return t.fail&&t.fail({errMsg:"Anchor is disabled"});this.createSelectorQuery().select(".top"+(t.id?">>>#"+t.id:"")).boundingClientRect().selectViewport().scrollOffset().exec(function(i){if(!i[0])return e.group?e.group.navigateTo(e.i,t):t.fail&&t.fail({errMsg:"Label not found"});t.scrollTop=i[1].scrollTop+i[0].top+(t.offset||0),wx.pageScrollTo(t)})},getText:function(){for(var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.data.html,i="",n=0;t=e[n++];)if("text"==t.type)i+=t.text.replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");else if("br"==t.type)i+="\n";else{var a="p"==t.name||"div"==t.name||"tr"==t.name||"li"==t.name||"h"==t.name[0]&&t.name[1]>"0"&&t.name[1]<"7";a&&i&&"\n"!=i[i.length-1]&&(i+="\n"),t.children&&(i+=this.getText(t.children)),a&&"\n"!=i[i.length-1]?i+="\n":"td"!=t.name&&"th"!=t.name||(i+="\t")}return i},getVideoContext:function(t){if(!t)return this.videoContexts;for(var e=this.videoContexts.length;e--;)if(this.videoContexts[e].id==t)return this.videoContexts[e]},setContent:function(n,a){var o,r=this,s=new i(n,this.data);if(this.data.useCache){var l=t(n);e[l]?o=e[l]:e[l]=o=s.parse()}else o=s.parse();this.triggerEvent("parse",o);var h={};if(a)for(var c=this.data.nodes.length,d=o.length;d--;)h["nodes["+(c+d)+"]"]=o[d];else h.nodes=o;this.showWithAnimation&&(h.showAm="animation: show .5s"),this.setData(h,function(){r.triggerEvent("load")}),o.title&&this.data.autosetTitle&&wx.setNavigationBarTitle({title:o.title}),this.imgList.length=0,this.videoContexts=[];for(var u,g=this.selectAllComponents(".top,.top>>>._node"),m=0;u=g[m++];){u.top=this;for(var f,p=0;f=u.data.nodes[p++];)if(!f.c)if("img"==f.name)this.imgList.setItem(f.attrs.i,f.attrs.src);else if("video"==f.name||"audio"==f.name){var v;v="video"==f.name?wx.createVideoContext(f.attrs.id,u):u.selectComponent("#"+f.attrs.id),v&&(v.id=f.attrs.id,this.videoContexts.push(v))}}var x;clearInterval(this._timer),this._timer=setInterval(function(){r.createSelectorQuery().select(".top").boundingClientRect(function(t){t&&(r.rect=t,t.height==x&&(r.triggerEvent("ready",t),clearInterval(r._timer)),x=t.height)}).exec()},350)}}})